<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>TeamTrack ‚Äî –ü—Ä–æ–µ–∫—Ç</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <header class="bg-white shadow mb-6">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <a href="/dashboard" class="text-indigo-600 hover:underline">‚Üê –ù–∞–∑–∞–¥</a>
      <h1 class="text-xl font-bold">TeamTrack</h1>
    </div>
  </header>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="container mx-auto px-6">
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ -->
    <div class="bg-white p-6 rounded shadow mb-6">
      <h2 class="text-2xl font-bold mb-2" id="projectTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
      <p class="text-gray-700 mb-2" id="projectDesc">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</p>
      <p class="text-sm text-gray-600 mb-1" id="projectMembers">–£—á–∞—Å—Ç–Ω–∏–∫–∏: ...</p>
    </div>

    <!-- –ó–∞–¥–∞—á–∏ -->
    <div class="bg-white p-6 rounded shadow mb-6">
      <h3 class="text-xl font-semibold mb-4">‚úÖ –ó–∞–¥–∞—á–∏</h3>
      <ul id="taskList" class="space-y-4">
        <li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>
      </ul>
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
    <div class="bg-white p-6 rounded shadow mb-10">
      <h3 class="text-xl font-semibold mb-4">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h3>
      <input type="text" id="taskText" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" class="border p-2 w-full mb-2 rounded" />
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <input type="email" id="taskAssignee" placeholder="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (email)" class="border p-2 rounded" />
        <select id="taskPriority" class="border p-2 rounded">
          <option value="">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
          <option value="high">üî¥ –í—ã—Å–æ–∫–∏–π</option>
          <option value="medium">üü° –°—Ä–µ–¥–Ω–∏–π</option>
          <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
        </select>
        <input type="date" id="taskDue" class="border p-2 rounded" />
      </div>
      <button onclick="addTask()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

  </main>

  <!-- Firebase + –ª–æ–≥–∏–∫–∞ -->
  <script type="module">
    import { auth, db, onAuthStateChanged } from "/static/firebase.js";
    import {
      doc, getDoc, collection, query, where, addDoc, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    let projectId = new URLSearchParams(window.location.search).get("id");
    let currentUser = null;

    const titleEl = document.getElementById("projectTitle");
    const descEl = document.getElementById("projectDesc");
    const membersEl = document.getElementById("projectMembers");
    const taskList = document.getElementById("taskList");

    async function loadProject() {
      const projectRef = doc(db, "projects", projectId);
      const projectSnap = await getDoc(projectRef);

      if (projectSnap.exists()) {
        const data = projectSnap.data();
        titleEl.textContent = data.name;
        descEl.textContent = data.description || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è";
        membersEl.textContent = "üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏: " + (data.members || []).join(", ");
      } else {
        titleEl.textContent = "–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω";
      }
    }

    function renderTasks() {
      const q = query(collection(db, "tasks"), where("projectId", "==", projectId));
      onSnapshot(q, (snapshot) => {
        taskList.innerHTML = "";
        if (snapshot.empty) {
          taskList.innerHTML = "<li class='text-gray-500'>–ù–µ—Ç –∑–∞–¥–∞—á</li>";
        }

        snapshot.forEach(doc => {
          const task = doc.data();
          const status = task.status === "done" ? "line-through text-gray-400" : "";
          const color = task.priority === "high" ? "text-red-600"
                      : task.priority === "medium" ? "text-yellow-600"
                      : "text-green-600";

          taskList.innerHTML += `
            <li class="p-4 border rounded ${task.status === "done" ? 'bg-gray-50' : ''}">
              <p class="font-medium ${status}">${task.text}</p>
              <p class="text-sm ${color}">${task.priority.toUpperCase()}</p>
              <p class="text-sm text-gray-500">üë§ ${task.assignee || "–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ"} | ‚è∞ ${task.dueDate || "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}</p>
            </li>
          `;
        });
      });
    }

    // üü¢ –°–¥–µ–ª–∞–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π ‚Äî —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∞ —á–µ—Ä–µ–∑ onclick
    window.addTask = async function () {
      const text = document.getElementById("taskText").value.trim();
      const assignee = document.getElementById("taskAssignee").value.trim();
      const priority = document.getElementById("taskPriority").value;
      const dueDate = document.getElementById("taskDue").value;

      console.log("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏:", { text, assignee, priority, dueDate, projectId });

      if (!text || !priority || !projectId) {
        console.warn("‚õî –ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–ª–∏ projectId –ø—É—Å—Ç");
        return;
      }

      try {
        const docRef = await addDoc(collection(db, "tasks"), {
          text,
          assignee,
          priority,
          dueDate,
          status: "active",
          projectId,
          createdAt: serverTimestamp()
        });

        console.log("‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞:", docRef.id);
      } catch (err) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏:", err);
      }

      document.getElementById("taskText").value = "";
      document.getElementById("taskAssignee").value = "";
      document.getElementById("taskPriority").value = "";
      document.getElementById("taskDue").value = "";
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "/login";
      } else {
        currentUser = user;
        loadProject();
        renderTasks();
      }
    });
  </script>
</body>
</html>
