<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>TeamTrack ‚Äî –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="icon" href="/static/favicon.ico">
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <!-- –®–∞–ø–∫–∞ -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-semibold text-indigo-600 tracking-tight">TeamTrack</h1>
      <nav class="flex items-center gap-4">
        <a id="backToProject" href="#" class="text-sm text-indigo-600 hover:underline">‚¨Ö –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–µ–∫—Ç—É</a>
        <a href="/profile" class="text-gray-600 hover:text-indigo-600 text-sm font-medium">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
      </nav>
    </div>
  </header>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="max-w-6xl mx-auto px-6 py-10">
    <h2 class="text-2xl md:text-3xl font-bold mb-8 text-gray-800">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</h2>

    <div class="grid gap-8 md:grid-cols-2">
      <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow transition">
        <h3 class="text-lg font-semibold mb-4 text-gray-700">–°—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á</h3>
        <canvas id="statusChart" height="200"></canvas>
      </div>
      <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow transition">
        <h3 class="text-lg font-semibold mb-4 text-gray-700">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞–¥–∞—á</h3>
        <canvas id="priorityChart" height="200"></canvas>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6 mt-10 hover:shadow transition">
      <h3 class="text-lg font-semibold mb-4 text-gray-700">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h3>
      <div class="w-full bg-gray-200 rounded-full h-4">
        <div id="progressBar" class="bg-green-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
      </div>
      <p id="progressText" class="mt-2 text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
  </main>

  <!-- –°–∫—Ä–∏–ø—Ç -->
  <script type="module">
    import { auth, db, onAuthStateChanged } from "/static/firebase.js";
    import {
      collection, query, where, getDocs, onSnapshot, getDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const params = new URLSearchParams(window.location.search);
    const projectId = params.get("id");

    // –ù–∞–∑–Ω–∞—á–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥
    const backBtn = document.getElementById("backToProject");
    if (projectId) {
      backBtn.href = `/project.html?id=${projectId}`;
    }

    const statusChartCtx = document.getElementById("statusChart").getContext("2d");
    const priorityChartCtx = document.getElementById("priorityChart").getContext("2d");
    let statusChart, priorityChart;
    let allTasks = [];

    async function loadAnalytics(user) {
      const projectRef = doc(db, "projects", projectId);
      const projectSnap = await getDoc(projectRef);

      if (!projectSnap.exists()) {
        document.getElementById("progressText").textContent = "–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.";
        return;
      }

      const projectData = projectSnap.data();
      if (!projectData.members.includes(user.email)) {
        document.getElementById("progressText").textContent = "–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –ø—Ä–æ–µ–∫—Ç—É.";
        return;
      }

      const tasksRef = query(collection(db, "tasks"), where("projectId", "==", projectId));
      onSnapshot(tasksRef, (snapshot) => {
        allTasks = snapshot.docs.map(doc => doc.data());
        updateCharts();
      });
    }

    function updateCharts() {
      const statusCounts = { todo: 0, 'in-progress': 0, done: 0 };
      const priorityCounts = { low: 0, medium: 0, high: 0 };

      allTasks.forEach(task => {
        statusCounts[task.status] = (statusCounts[task.status] || 0) + 1;
        priorityCounts[task.priority] = (priorityCounts[task.priority] || 0) + 1;
      });

      const total = allTasks.length;
      const done = statusCounts.done || 0;
      const percent = total === 0 ? 0 : Math.round((done / total) * 100);
      document.getElementById("progressBar").style.width = percent + "%";
      document.getElementById("progressText").textContent = total === 0
        ? "–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞."
        : `–í—ã–ø–æ–ª–Ω–µ–Ω–æ ${done} –∏–∑ ${total} –∑–∞–¥–∞—á (${percent}%)`;

      if (statusChart) statusChart.destroy();
      if (priorityChart) priorityChart.destroy();

      statusChart = new Chart(statusChartCtx, {
        type: "doughnut",
        data: {
          labels: ["To Do", "In Progress", "Done"],
          datasets: [{
            data: [statusCounts.todo, statusCounts["in-progress"], statusCounts.done],
            backgroundColor: ["#f87171", "#facc15", "#4ade80"]
          }]
        }
      });

      priorityChart = new Chart(priorityChartCtx, {
        type: "bar",
        data: {
          labels: ["Low", "Medium", "High"],
          datasets: [{
            label: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
            data: [priorityCounts.low, priorityCounts.medium, priorityCounts.high],
            backgroundColor: ["#4ade80", "#facc15", "#f87171"]
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "/login";
      } else {
        loadAnalytics(user);
      }
    });
  </script>
</body>
</html>
